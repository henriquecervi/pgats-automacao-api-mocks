name: ğŸ¦ Bank API CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Lint and Security Check
  lint-and-security:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”’ Run security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: ğŸ“Š Check for outdated packages
      run: npm outdated
      continue-on-error: true

  # Job 2: Test Suite
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: lint-and-security
    
    strategy:
      matrix:
        node-version: [16, 18, 20]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸƒâ€â™‚ï¸ Run all tests
      run: npm test
      
    - name: ğŸ“ˆ Generate detailed test report
      if: matrix.node-version == '18'
      run: npm run test:report
      
    - name: ğŸ“Š Upload test results (backup)
      if: matrix.node-version == '18'
      uses: actions/upload-artifact@v4
      with:
        name: test-report-backup
        path: test-results/
        retention-days: 7
        
    - name: ğŸ’¾ Upload test coverage (if available)
      if: matrix.node-version == '18'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30
      continue-on-error: true

  # Job 3: Service Tests by Category
  test-categories:
    name: ğŸ¯ Test Categories
    runs-on: ubuntu-latest
    needs: lint-and-security
    
    strategy:
      matrix:
        test-type: [controllers, services, integration, system]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run ${{ matrix.test-type }} tests
      run: npm run test:${{ matrix.test-type }}

  # Job 4: API Health Check
  api-health-check:
    name: ğŸ¥ API Health Check
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸš€ Start API server in background
      run: |
        npm start &
        echo $! > server.pid
        sleep 5
        
    - name: ğŸ¥ Check API health endpoint
      run: |
        curl -f http://localhost:3000/health || exit 1
        echo "âœ… API Health Check passed!"
        
    - name: ğŸ“š Check Swagger documentation
      run: |
        curl -f http://localhost:3000/api-docs/ || exit 1
        echo "âœ… Swagger documentation is accessible!"
        
    - name: ğŸ”— Check Swagger JSON
      run: |
        curl -f http://localhost:3000/swagger.json || exit 1
        echo "âœ… Swagger JSON is valid!"
        
    - name: ğŸ›‘ Stop API server
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
          rm server.pid
        fi

  # Job 5: Build and Package
  build:
    name: ğŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: [test, test-categories, api-health-check]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci --only=production
      
    - name: ğŸ“‹ Generate build info
      run: |
        echo "ğŸ—ï¸ Build completed successfully!" > build-info.txt
        echo "ğŸ“… Build date: $(date)" >> build-info.txt
        echo "ğŸ”– Git commit: ${{ github.sha }}" >> build-info.txt
        echo "ğŸŒ¿ Git branch: ${{ github.ref_name }}" >> build-info.txt
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}" >> build-info.txt
        
    - name: ğŸ“Š Create package info
      run: |
        echo "ğŸ“¦ Package contents:" >> build-info.txt
        ls -la >> build-info.txt
        
    - name: ğŸ’¾ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: banco-api-build
        path: |
          .
          !node_modules
          !.git
          !test-results
          !coverage
        retention-days: 30

  # Job 6: Notification and Summary
  notify:
    name: ğŸ“¢ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint-and-security, test, test-categories, api-health-check, build]
    if: always()
    
    steps:
    - name: ğŸ“Š Pipeline Summary
      run: |
        echo "ğŸ¦ ===== BANCO API CI/CD PIPELINE SUMMARY ====="
        echo ""
        echo "ğŸ” Code Quality & Security: ${{ needs.lint-and-security.result }}"
        echo "ğŸ§ª Test Suite: ${{ needs.test.result }}"
        echo "ğŸ¯ Test Categories: ${{ needs.test-categories.result }}"
        echo "ğŸ¥ API Health Check: ${{ needs.api-health-check.result }}"
        echo "ğŸ—ï¸ Build & Package: ${{ needs.build.result }}"
        echo ""
        echo "ğŸ“… Pipeline executed on: $(date)"
        echo "ğŸ”– Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo ""
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… Pipeline completed successfully! ğŸ‰"
          echo "ğŸš€ Ready for deployment!"
        else
          echo "âŒ Pipeline failed! Please check the logs."
          exit 1
        fi
